{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col-md-6">
    <h3>Real-time Crash Detection (Simulated)</h3>
    <p>This page simulates SwiftAid behaviour with GPS & accelerometer sensors.</p>

    <p>Accel: <span id="speed"></span></p>

    <div class="mb-3">
      <label class="form-label">User ID</label>
      <input id="userId" class="form-control" value="user_001">
    </div>

    <div class="mb-2">
      <button id="simulateCrashBtn" class="btn btn-danger">Simulate Crash</button>
      <button id="manualSosBtn" class="btn btn-warning">Send Manual SOS</button>
    </div>

    <div id="countdownArea" class="mt-3" style="display:none;">
      <p><strong>Cancel window:</strong> <span id="countdown">10</span>s remaining</p>
      <button id="cancelBtn" class="btn btn-secondary">Cancel Alert</button>
    </div>

    <div id="result" class="mt-3"></div>

  </div>

  <div class="col-md-6">
    <h3>Quick Simulation Controls</h3>
    <p>Set simulated GPS and sensor values:</p>
    <div class="row g-2">
      <div class="col-6"><input id="lat" class="form-control" placeholder="Latitude" value="12.9716"></div>
      <div class="col-6"><input id="lng" class="form-control" placeholder="Longitude" value="77.5946"></div>
      <div class="col-6"><input id="accel" class="form-control" placeholder="Accel magnitude (m/s²)" value="18.5"></div>
      <div class="col-6"><input id="speed" class="form-control" placeholder="Speed (km/h)" value="70"></div>
    </div>
    <hr>
    <h5>Contacts (configured)</h5>
    <ul id="contactsList">
      {% for c in contacts %}
        <li>{{ c.name }} — {{ c.phone }} / {{ c.email }}</li>
      {% else %}
        <li>No contacts set. Go to Contacts page to add.</li>
      {% endfor %}
    </ul>
  </div>
</div>

<!-- 🚀 JS for Crash Detection + Manual SOS -->
<script>

    const audio = new Audio({{ url_for('static', filename='alert.mp3') }});

  // --- GPS Helper ---
  function getLocation(callback) {
      if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
              (position) => {
                  callback({
                      lat: position.coords.latitude,
                      lng: position.coords.longitude
                  });
              },
              (error) => {
                  console.error("GPS error:", error);
                  callback(null);
              }
          );
      } else {
          alert("Geolocation not supported");
          callback(null);
      }
  }

  // --- Accelerometer ---
  let latestAccel = 0;
  function getAccelMag(event) {
      let ax = event.acceleration?.x ?? 0;
      let ay = event.acceleration?.y ?? 0;
      let az = event.acceleration?.z ?? 0;
      return Math.sqrt(ax * ax + ay * ay + az * az);
  }
  window.addEventListener("devicemotion", (event) => {
    console.log(event.acceleration);
    document.getElementById("speed").innerHTML = ${getAccelMag(event.acceleration)};
      latestAccel = getAccelMag(event);
      console.log(latestAccel);
      // 🚨 Auto crash detection threshold (e.g., > 25 m/s²)
      if (latestAccel > 25) {
          console.log("🚨 Crash detected! Accel:", latestAccel);
          startCountdown(false);  // auto crash SOS
      }
  });

  // --- Send SOS ---
  function sendSOS(isManual = false) {
      getLocation((loc) => {
          if (!loc) {
              alert("Location not available");
              return;
          }

          const payload = {
              user_id: document.getElementById("userId").value || "anonymous",
              lat: loc.lat,
              lng: loc.lng,
              accel_mag: latestAccel || document.getElementById("accel").value,
              speed: document.getElementById("speed").value || 0,
              metadata: { manual: isManual }
          };

          fetch("/api/report-accident", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
          })
          .then(res => res.json())
          .then(data => {
              console.log("✅ SOS sent:", data);
              document.getElementById("result").innerHTML = 
                  <div class="alert alert-success">🚨 SOS Sent! ID: ${data.incident_id}</div>;
          })
          .catch(err => console.error("❌ Error sending SOS:", err));
      });
  }

  // --- Cancel Window ---
  let countdownInterval, countdownValue, sosTimer;

  function startCountdown(isManual) {
      countdownValue = 10;
      document.getElementById("countdown").innerText = countdownValue;
      document.getElementById("countdownArea").style.display = "block";
      

      clearInterval(countdownInterval);
      clearTimeout(sosTimer);

      countdownInterval = setInterval(() => {
          countdownValue--;
          document.getElementById("countdown").innerText = countdownValue;
          audio.play()
          
          if (countdownValue <= 0) {
              clearInterval(countdownInterval);
          }
      }, 1000);

      sosTimer = setTimeout(() => {
          sendSOS(isManual);
          document.getElementById("countdownArea").style.display = "none";
      }, 10000);
  }

  document.getElementById("cancelBtn").addEventListener("click", () => {
      clearTimeout(sosTimer);
      clearInterval(countdownInterval);
      document.getElementById("countdownArea").style.display = "none";
      document.getElementById("result").innerHTML = 
          <div class="alert alert-info">🚫 SOS cancelled by user</div>;
  });

  // --- Buttons ---
  document.getElementById("manualSosBtn").addEventListener("click", () => {
      startCountdown(true);
  });
  document.getElementById("simulateCrashBtn").addEventListener("click", () => {
      startCountdown(false);
  });
</script>
{% endblock %}
